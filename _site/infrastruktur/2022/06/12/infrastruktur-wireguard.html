<h1 id="motivation">Motivation</h1>

<p>Für mein Wohnmobilprojekt habe ich mir einne GL.iNet Beryl Reiserouter gekauft. Dise kleinen Dinger aus Hong Kong basieren auf OpenWRT und bieten für schmales Geld (35-80 Euro) eine gute Basis um unterwegs mehrere Geräte mit geringem Aufwand zu betreiben.<br />
Die Grundidee ist, dass ich nicht jede smeiner Geräte im (Hotel)WLAN anmeldne muss, sondenr den Router vorschalte un ddieser einen sicherne Zugang für alle meine Geräte stellt. Sicher, weil die kleinen Router standardmäßig eine Unterstützung für gängige Protokolle, wie OpenVPN und WireGuard mitbringen. Wer keine Möglickeit hat einen Endpunkt zu mieten oder selbst aufzubauen, dem steht immernoch per Klick das TOR Netzwerk offen.<br />
Mit OpenVPN bin ich nie warm geworden, daher versuche ich mich am aktuelleren WireGuard.</p>

<h2 id="wireguard-skript---erste-schritte">WireGuard Skript - Erste Schritte</h2>

<p>Wireguard bietet für Linux ein ‘All in One’ Skript an. Dieses ist genauso gruselig, wie es klingt. Es wird aus dem internet heruntergeladen und ausgeführt …</p>

<blockquote>
  <p>wget https://git.io/wireguard -O wireguard-install.sh &amp;&amp; sudo bash<br />
wireguard-install.sh</p>
</blockquote>

<p>Als erste Testumgebung habe ich damit angefangen, und es funktioniert.</p>

<p>Dann wollte ich den Service auf meine Umgebung anpassen. Also Konfiguration unter <code class="language-plaintext highlighter-rouge">/etc/wireguard/</code> anpassen und den Dienst neu starten … den Dienst … den Dienst … Wo ist der denn? … Server durchstarten geht auch.<br />
Schon vorher wollte ich dringend das Skript gegen eine saubere Installation ersetzen. Spätestens an dem Punkt war mir die Dringlichkeit bewusst.</p>

<h1 id="wireguard-aufsetzen">Wireguard aufsetzen</h1>

<p>Im Proxmox schnell einen Container erstellt. Debian 11.0.3 Image, 12GB Festplatte auf der lokalen SSD, 1Core, 512MB RAM und im Netzwerk ‘vmbr1 - Green’. Container starten.</p>

<p>Ab Debian 11 ist das paket <a href="https://packages.debian.org/bullseye/wireguard">wireguard</a> mitgeliefert, davor benötigt es <a href="https://packages.debian.org/buster-backports/wireguard">Backports</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@walter01:~# apt update &amp;&amp; apt full-upgrade
[.. update magie ..]
root@walter01:~# apt install wireguard wireguard-tools linux-headers-amd64
[.. install magie ..]
root@walter01:~# wg genkey | sudo tee /etc/wireguard/server_private.key | wg pubkey | sudo tee /etc/wireguard/server_public.key
[.. key generation magie ..]
cF+ZkxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxXiEc=
</code></pre></div></div>

<h2 id="wireguard-auf-dem-server">WireGuard auf dem Server</h2>

<p>Die Konfigurationsdatei erstellen:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@walter01:~# vim /etc/wireguard/wg0.conf
</code></pre></div></div>

<blockquote>
  <p>[Interface]
Address = 10.10.10.1/24
ListenPort = 51820
PrivateKey = cF+ZkxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxXiEc=</p>
</blockquote>

<p>Darunter kommt noch ein wenig mit [Peers], sobald man einen client hat.</p>

<p>Und die Dateien für den Zugriff durch Unbefugte auf dem System sichern:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chmod 600 /etc/wireguard/ -R
</code></pre></div></div>

<h2 id="vom-schlichten-server-zum-funktionalen-router">Vom schlichten Server zum funktionalen Router</h2>

<p>Jetzt kann der Server zwar erreicht werden, aber er ist noch kein Router.</p>

<h3 id="routing-aktivieren">Routing aktivieren</h3>

<p>Um das zu ändern geben wir folgendes ein (Zeile 27 zur Erstellung diesen Artikels):<br />
<code class="language-plaintext highlighter-rouge">root@walter01:~# vim /etc/sysctl.conf</code></p>

<blockquote>
  <p>[…]</p>
  <h1 id="uncomment-the-next-line-to-enable-packet-forwarding-for-ipv4">Uncomment the next line to enable packet forwarding for IPv4</h1>
  <p>net.ipv4.ip_forward = 1
[…]</p>
</blockquote>

<p>Dienst neu starten:<br />
<code class="language-plaintext highlighter-rouge">sudo sysctl -p</code></p>

<h3 id="masquerading-aktivieren">Masquerading aktivieren</h3>

<p>Ich nutze hier <code class="language-plaintext highlighter-rouge">ufw</code>, welches ein Frontend für die <code class="language-plaintext highlighter-rouge">iptables</code> ist. Es gibt verschiedene Wege an das Ziel zu kommen, das hier ist nur ein Vorschlag.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@walter01:~# apt install ufw
root@walter01:~# ufw allow 22/tcp
</code></pre></div></div>

<p>Mit <code class="language-plaintext highlighter-rouge">ip addr</code> ist zu sehen auf welchem Interface die IP gebunden ist. Auf dieser erlauben wir nun das NAT.</p>

<p><code class="language-plaintext highlighter-rouge">vim /etc/ufw/before.rules</code></p>

<p>Vor dem COMMIT wird das Masquerading aktiviert. das Interface (-o) mit dem Interface aus <code class="language-plaintext highlighter-rouge">ip addr</code> ersetzen!</p>

<blockquote>
  <p>[…]</p>
  <h1 id="allow-multicast-upnp-for-service-discovery-be-sure-the-multicast-line-above">allow MULTICAST UPnP for service discovery (be sure the MULTICAST line above</h1>
  <h1 id="is-uncommented">is uncommented)</h1>
  <p>-A ufw-before-input -p udp -d 239.255.255.250 –dport 1900 -j ACCEPT</p>

  <h1 id="nat-rules">NAT rules</h1>
  <p>*nat
:POSTROUTING ACCEPPT [0:0]
-A POSTROUTING -o eth0@if110 -j MASQUERADE</p>

  <h1 id="dont-delete-the-commit-line-or-these-rules-wont-be-processed">don’t delete the ‘COMMIT’ line or these rules won’t be processed</h1>
  <p>COMMIT</p>
</blockquote>

<p>Und um im VPN die Kommunikation zwiwchen den Hosts zu erkauben, folgenden Block (unten) ergänzen:</p>

<blockquote>
  <h1 id="ok-icmp-code-for-forward">ok icmp code for FORWARD</h1>
  <p>-A ufw-before-forward -p icmp –icmp-type destination-unreachable -j ACCEPT
-A ufw-before-forward -p icmp –icmp-type time-exceeded -j ACCEPT
-A ufw-before-forward -p icmp –icmp-type parameter-problem -j ACCEPT
-A ufw-before-forward -p icmp –icmp-type echo-request -j ACCEPT</p>

  <h1 id="allow-forwarding-trusted-network">allow forwarding trusted network</h1>
  <p>-A ufw-before-forward -s 10.10.10.0/24 -j ACCEPT
-A ufw-before-forward -d 10.10.10.0/24 -j ACCEPT</p>
</blockquote>

<h3 id="aktivieren-der-regeln">Aktivieren der Regeln</h3>

<p>Und jetzt hoffen, dass man sich nicht aussperrt:<br />
<code class="language-plaintext highlighter-rouge">ufw enable</code></p>

<p>Beim ersten Ausführen gab es einen Fehler mit dem Eintrag <code class="language-plaintext highlighter-rouge">*nat</code>. Beim zweiten Ausführen wurden die Regeln übernommen.</p>

<p>Eine letzte Prüfung:<br />
<code class="language-plaintext highlighter-rouge">root@walter01:~# iptables -t nat -L POSTROUTING</code></p>

<h1 id="aktivieren-von-wireguard-auf-dme-server">Aktivieren von WireGuard auf dme Server</h1>

<p>Als erstes geben wir den WireGuard (Standard-)Port frei:<br />
<code class="language-plaintext highlighter-rouge">ufw allow 51820/udp</code></p>

<p>Zum Testen reicht es aus temporär den Dienst zu starten:
<code class="language-plaintext highlighter-rouge">wg-quick up /etc/wireguard/wg0.conf</code></p>

<p>Wollen wir den Dienst bei jedem Systemstart aktivieren, geben wir ein:<br />
<code class="language-plaintext highlighter-rouge">sudo systemctl enable wg-quick@wg0.service</code></p>

<p>Zum Kontrollieren ob alles läuft geben wir ein:<br />
<code class="language-plaintext highlighter-rouge">systemctl status wg-quick@wg0.service</code></p>
